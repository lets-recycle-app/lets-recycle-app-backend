# MySQL Database Install Utilities

Utilities to install or reinstall MySQL tables and core data for a database hosted on AWS.

The table definitions reside in *databaseTable.js* and the core data generators in *databaseCoreData.js* .

Simulated route data can be regenerated by running *generateRoutes.js* .


```javascript
npm databaseSetup   // reinstall the database along with the core data for depots & drivers 
npm generateRoutes  // generate routes for all depots and all forward days
````

The database utilities rely on running statements in order so therefore use an 
asynchronous queuing system.

To connect to the MySQL database, first create an 'AWS Secret' with a key name that matches the database instance name.
Set the secret value to be a json object with connection settings as shown in the example below.
```javascript
{
    "host": "prod-instance.iwolqkjmdnhwf.eu-west-2.rds.amazonaws.com",
    "user": "admin",
    "password": "uNhKDj&H54%K",
    "database": "rockets"
}
```

Prior to executing any SQL statements, initialise dbControl() 
and connect with the correct AWS region and MySQL instance name e.g.

```javascript
const db = dbControl();
await db.connect({ store, region: 'eu-west-2', dbInstance: 'prod-mysql' });
```

Execute SQL statement text in the order of execution required by calling db.sql() e.g.

```javascript

const store = dataStore();
const db = dbControl();

(async () => {
  await db.connect({ store, region: 'eu-west-2', dbInstance: 'prod-mysql' });
  await db.sql(createUsers);
  await db.sql('select * from users;', 'users')
    .then(() => { db.close(); });

  showTable(store.get('users')[0]);
})();
```

Multiple SQL statements can be defined in a single string variable. 
The sql statements will be executed asynchronously in order e.g.

```javascript
import { dbControl } from './dbControl.js';
import { dataStore, showTable } from './dbUtils.js';

const createUsers = `

drop table if exists users;

create table users (
  id int not null auto_increment,
  forename varchar(30) not null,
  surname varchar(30) not null,
  department varchar(20) not null,
  primary key (id)
);

alter table users auto_increment=1;

insert into users (forename, surname, department) 
values
('Alice', 'Brown', 'Admin'),
('Bob', 'Newman', 'Finance');
`;

const store = dataStore();
const db = dbControl();

(async () => {
  await db.connect({ store, region: 'eu-west-2', dbInstance: 'prod-mysql' });
  await db.sql(createUsers);
  await db.sql('select * from users;', 'users')
    .then(() => { db.close(); });

  showTable(store.get('users')[0]);
  console.log('#####\n');
  console.log(store.get('users')[0]);
})();

```
The above SQL queue will execute with the following output:
```javascript
{ 1 , Alice , Brown , Admin }
{ 2 , Bob , Newman , Finance }

#####

  [
    { id: 1, forename: 'Alice', surname: 'Brown', department: 'Admin' },
    { id: 2, forename: 'Bob', surname: 'Newman', department: 'Finance' }
  ]
```

End.
