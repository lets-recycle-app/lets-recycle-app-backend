# MySQL Database Install Utilities

Utilities to install or reinstall MySQL tables and core data for a database hosted on AWS.

The table definitions reside in *databaseTable.js* and the core data generators in *databaseCoreData.js* .

Simulated route data can be regenerated by running *generateRoutes.js* .


```javascript
npm databaseSetup   // reinstall the database along with the core data for depots & drivers 
npm generateRoutes  // generate routes for all depots and all forward days
````

The database utilities rely on running statements in order so therefore use an 
asynchronous queuing system defined in *asyncList.js* .

To connect to the MySQL database, first create an 'AWS Secret' with a key name that matches the database instance name.
Set the secret value to be a json object with connection settings as shown in the example below.
```javascript
{
    "host": "prod-instance.iwolqkjmdnhwf.eu-west-2.rds.amazonaws.com",
    "user": "admin",
    "password": "uNhKDj&H54%K",
    "database": "rockets"
}
```

Prior to executing any SQL statements, initialise dbControl() and asyncList() 
and connect with the correct AWS region and MySQL instance name e.g.

```javascript
const db = dbControl();
const a = asyncList();

a.add(db.connect, { region: 'eu-west-2', dbInstance: 'prod-mysql' });
```

Add SQL statement text in the order of execution required to a single threaded processing queue with db.add(). 
Execute the SQL queue by calling db.run() e.g.
```javascript

db.add('show tables');
db.add(clearUsers);

db.run().then(() => {
  console.log('Installation completed.');
});
```

The asynchronous queues can be infinitely nested using sub-queues. 

Multiple SQL statements can be defined in a single string variable. 
The sql statements will be executed asynchronously in order e.g.

```javascript
import { asyncList } from './asyncList.js';
import { dbControl } from './dbControl.js';
import { showTable } from './dbUtils.js';

const createUsers = `

drop table if exists users;

create table users (
  id int not null auto_increment,
  forename varchar(30) not null,
  surname varchar(30) not null,
  department varchar(20) not null,
  primary key (id)
);

alter table users auto_increment=1;

insert into users (forename, surname, department) 
values
('Alice', 'Brown', 'Admin'),
('Bob', 'Newman', 'Finance');
`;

const db = dbControl();
const a = asyncList();

a.add(db.connect, { region: 'eu-west-2', dbInstance: 'prod-mysql' });
a.add(db.sql, { sql: createUsers });
a.add(db.sql, { sql: 'select * from users;', id: 'users' });

a.run().then(() => {
  db.close();
  showTable(a.fetch('users'));
  console.log('#####\n');
  console.log(a.fetch('users'));
});
```
The above SQL queue will execute with the following output:
```javascript
{ 1 , Alice , Brown , Admin }
{ 2 , Bob , Newman , Finance }

#####

  [
    { id: 1, forename: 'Alice', surname: 'Brown', department: 'Admin' },
    { id: 2, forename: 'Bob', surname: 'Newman', department: 'Finance' }
  ]
```
